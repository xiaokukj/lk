<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>安全跳转页面</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    /* 三点加载动画样式 */
    .container {
      width: 100px;
      height: 100px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: rotate-move 2s ease-in-out infinite;
      display: none;
    }
    .dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;
    }
    .dot-3 { background-color: #f74d75; animation: dot-3-move 2s ease infinite; }
    .dot-2 { background-color: #10beae; animation: dot-2-move 2s ease infinite; }
    .dot-1 { background-color: #ffe386; animation: dot-1-move 2s ease infinite; }
    
    @keyframes dot-3-move {
      20%,100% { transform: scale(1) }
      45%,80% { transform: translateY(-18px) scale(.45) }
    }
    @keyframes dot-2-move {
      20%,100% { transform: scale(1) }
      45%,80% { transform: translate(-16px, 12px) scale(.45) }
    }
    @keyframes dot-1-move {
      20%,100% { transform: scale(1) }
      45%,80% { transform: translate(16px, 12px) scale(.45) }
    }
    @keyframes rotate-move {
      55% { transform: translate(-50%, -50%) rotate(0deg) }
      80%,100% { transform: translate(-50%, -50%) rotate(360deg) }
    }

    /* 全局水印样式 */
    .watermark {
      position: fixed;
      pointer-events: none;
      width: 100%;
      height: 100%;
      background-image: repeating-linear-gradient(
        -45deg,
        rgba(255, 0, 0, 0.1),
        rgba(255, 0, 0, 0.1) 20px,
        rgba(0, 0, 255, 0.1) 20px,
        rgba(0, 0, 255, 0.1) 40px
      );
      z-index: 9999;
      display: none;
    }
    .watermark-text {
      position: absolute;
      color: rgba(255, 0, 0, 0.6);
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      width: 100%;
      top: 50%;
      transform: translateY(-50%);
      text-shadow: 1px 1px 1px #fff;
    }

    /* iframe样式 */
    .content {
      height: 100%;
      width: 100%;
      position: fixed;
      inset: -2px;
      z-index: 1;
      border: none;
    }
    
    /* 错误提示样式 */
    .error-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 20px;
      border-radius: 10px;
      text-align: center;
      max-width: 80%;
      display: none;
      z-index: 10000;
    }
  </style>
</head>

<body>
  <!-- 三点加载动画容器 -->
  <div class="container" id="loadingContainer">
    <div class="dot dot-1"></div>
    <div class="dot dot-2"></div>
    <div class="dot dot-3"></div>
  </div>

  <!-- 全局水印 -->
  <div class="watermark" id="watermark">
    <div class="watermark-text">提示：请联系老K VX：tuiguanglao 授权</div>
  </div>
  
  <!-- 错误提示 -->
  <div class="error-message" id="errorMessage">
    <h3>链接解析失败或无效</h3>
    <p id="errorDetail">请检查链接是否正确或联系管理员</p>
    <p>VX：tuiguanglao</p>
  </div>

  <script>
    (function() {
      // 配置项
      const CONFIG = {
        apiEndpoint: 'https://1268798dy.xn--ltwa.xn--fiqs8s/whitelist.php',
        watermarkText: '提示：请联系老K VX：tuiguanglao 授权',
        cacheDuration: 3600000, // 白名单缓存时间(毫秒)，1小时
        staticWhitelist: ['puut.cn'] // 静态白名单作为备用
      };

      // 固定密钥
      const STATIC_KEY = "LK@2099#Secure$Link&Tech!StaticKey";
      const STATIC_IV = "LK@StaticVector2099";
      
      // 白名单缓存
      let whitelistCache = {
        domains: CONFIG.staticWhitelist, // 默认使用静态白名单
        lastUpdated: 0
      };

      // 显示三点加载动画
      function showLoadingAnimation() {
        document.getElementById('loadingContainer').style.display = 'block';
      }
      
      // 显示错误信息
      function showError(message) {
        document.getElementById('loadingContainer').style.display = 'none';
        const errorEl = document.getElementById('errorMessage');
        const errorDetail = document.getElementById('errorDetail');
        
        if (message) {
          errorDetail.textContent = message;
        }
        errorEl.style.display = 'block';
      }

      // 从API获取白名单（带跨域处理）
      async function fetchWhitelist() {
        // 检查缓存是否有效
        const now = Date.now();
        if (now - whitelistCache.lastUpdated < CONFIG.cacheDuration && whitelistCache.domains.length > 0) {
          return { success: true, domains: whitelistCache.domains };
        }
        
        try {
          // 使用代理模式避免CORS问题
          const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(CONFIG.apiEndpoint)}`;
          const response = await fetch(proxyUrl, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`API请求失败: ${response.status}`);
          }
          
          const data = await response.json();
          const responseData = JSON.parse(data.contents);
          
          // 检查API是否返回错误
          if (responseData.error) {
            return { success: false, error: responseData.error };
          }
          
          if (!responseData || !Array.isArray(responseData.domains)) {
            throw new Error('无效的白名单数据格式');
          }
          
          // 更新缓存
          whitelistCache = {
            domains: responseData.domains,
            lastUpdated: now
          };
          
          return { success: true, domains: responseData.domains };
        } catch (error) {
          console.error('获取白名单失败:', error);
          // 返回缓存数据或静态白名单
          return { 
            success: whitelistCache.domains.length > 0,
            domains: whitelistCache.domains,
            error: whitelistCache.domains.length > 0 ? null : '无法获取白名单数据'
          };
        }
      }

      // AES解密函数
      function decryptUrl(encrypted) {
        try {
          // 处理URL安全的Base64编码
          encrypted = encrypted.replace(/-/g, '+').replace(/_/g, '/');
          while (encrypted.length % 4) {
            encrypted += '=';
          }
          
          const key = CryptoJS.enc.Utf8.parse(STATIC_KEY.substr(0, 32));
          const iv = CryptoJS.enc.Utf8.parse(STATIC_IV.substr(0, 16));
          
          // 使用AES-CBC模式解密
          const decrypted = CryptoJS.AES.decrypt(encrypted, key, {
            iv: iv,
            mode: CryptoJS.mode.CBC,
            padding: CryptoJS.pad.Pkcs7
          });
          
          // 先解密得到Base64，再解码得到原始URL
          const base64Url = decrypted.toString(CryptoJS.enc.Utf8);
          return atob(base64Url);
        } catch (e) {
          console.error("解密失败:", e);
          return null;
        }
      }

      // 验证URL域名是否在白名单
      async function isAllowedDomain(url, whitelist) {
        try {
          const domain = new URL(url).hostname.replace('www.', '');
          return whitelist.some(allowedDomain => {
            return domain === allowedDomain || 
                   domain.endsWith('.' + allowedDomain);
          });
        } catch (e) {
          console.error('URL解析失败:', e);
          return false;
        }
      }
     
      // 主处理逻辑
      async function processRedirect() {
        showLoadingAnimation();
        
        const urlParams = new URLSearchParams(window.location.search);
        const encryptedParam = urlParams.get('k');
        
        if (!encryptedParam) {
          showError('缺少必要的参数');
          document.getElementById('watermark').style.display = 'block';
          return;
        }
        
        try {
          // 解密URL
          const trueUrl = decryptUrl(encryptedParam);
          
          if (!trueUrl || !trueUrl.startsWith('http')) {
            showError('无效的加密链接或链接格式不正确');
            return;
          }
          
          // 获取白名单
          const result = await fetchWhitelist();
          
          // 如果获取白名单失败且没有缓存
          if (!result.success && result.error) {
            showError(result.error);
            return;
          }
          
          const whitelist = result.domains;
          
          // 检查域名是否在白名单
          const allowed = await isAllowedDomain(trueUrl, whitelist);
          
          if (!allowed) {
            document.getElementById('watermark').style.display = 'block';
            document.querySelector('.watermark-text').textContent = CONFIG.watermarkText;
            showError('目标域名不在白名单中');
            return;
          }
          
          // 创建并加载iframe
          const iframe = document.createElement('iframe');
          iframe.className = 'content';
          iframe.src = trueUrl;
          
          iframe.addEventListener('load', function() {
            document.getElementById('loadingContainer').style.display = 'none';
          });
          
          iframe.addEventListener('error', function() {
            showError('目标页面加载失败，请检查链接是否有效');
          });
          
          document.body.appendChild(iframe);
        } catch (e) {
          console.error('处理跳转失败:', e);
          showError('系统错误: ' + e.message);
        }
      }

      // 安全防护措施
      function setupSecurity() {
        // 禁止F12开发者工具
        document.addEventListener('keydown', function(e) {
          if (e.key === 'F12' || 
              (e.ctrlKey && e.shiftKey && e.key === 'I') || 
              (e.ctrlKey && e.shiftKey && e.key === 'J') || 
              (e.ctrlKey && e.key === 'U')) {
            e.preventDefault();
            showError('开发者工具已禁用');
          }
        });
        
        // 禁用右键菜单
        document.addEventListener('contextmenu', function(e) {
          e.preventDefault();
          showError('右键菜单已禁用');
        });
        
        // 调试器检测（优化版）
        function detectDevTools() {
          try {
            const start = Date.now();
            debugger;
            const end = Date.now();
            // if (end - start > 100) {
            //   window.location.href = '/about:blank';
            // }
          } catch (e) {
            console.error('调试器检测错误:', e);
          }
        }
        setInterval(detectDevTools, 1000);
      }

      // 初始化
      setupSecurity();
      processRedirect();
    })();
  </script>
</body>
</html>
